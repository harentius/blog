#!/bin/sh

set -e; set -u
. "$(dirname $0)/common"




dump_name="${1:-}"

if [ -z "$dump_name" ]; then
    echo "You should provide database dump name"
    exit 1
fi

dump_dir="$BASE_DIR/var/db-dumps"
dump_file="$dump_dir/${dump_name}.sql.gz"

if [ ! -e "$dump_dir" ]; then
    mkdir -p "$dump_dir"
fi

if [ -f "$dump_file" ]; then
    echo "Database dump file already exists"
    exit 1
fi

write_title "Dumping database to '$dump_file'"
mysqldump \
    $(get_switch "-u " "$(read_env_parameter DATABASE_USER root)") \
    $(get_switch "-p" "$(read_env_parameter DATABASE_PASSWORD)") \
    $(get_switch "-h " "$(read_env_parameter DATABASE_HOST localhost)") \
    $(get_switch "-P " "$(read_env_parameter DATABASE_PORT 3306)") \
    "$(read_env_parameter DATABASE_NAME)" \
    | gzip -c > "$dump_file"
