#!/bin/sh

set -e; set -u
. "$(dirname $0)/common"


get_current_user() {
    if [ "$(id -u)" -eq 0 -a ! -z "${SUDO_USER:-}" ]; then
        echo "$SUDO_USER"
    else
        echo "$(whoami)"
    fi
}

set_acl_full() {
    user="$(get_current_user)"
    set +e
    find "$@" -type d -print0 | xargs -0 setfacl -d -m u:www-data:rwX -m u:$user:rwX
    find "$@" -print0 | xargs -0 setfacl -m u:www-data:rwX -m u:$user:rwX
    set -e
}

set_acl_limited() {
    user="$(get_current_user)"
    set +e
    find "$@" -type d -print0 | xargs -0 setfacl -d -m u:www-data:rX -m u:$user:rwX
    find "$@" -print0 | xargs -0 setfacl -m u:www-data:rX -m u:$user:rwX
    set -e
}

remove_acl() {
    setfacl -bR "$@"
}

case "${1:-apply}" in
    apply)
        write_title "Setting up permissions"
        set_acl_full \
            "$app_dir/cache" "$app_dir/logs" "$base_dir/var" \
            "$web_dir/assets/audios" "$web_dir/assets/files" "$web_dir/assets/images" \
            "$web_dir/assets/images/preview"
    ;;

    remove)
        write_title "Removing permissions"
        remove_acl "$base_dir"
    ;;

    *)
        echo "$0 Invalid operation"
    ;;
esac
